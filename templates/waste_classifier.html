{% extends 'base.html' %}

{% block title %}AI Waste Classifier{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
{% endblock %}

{% block content %}
<div class="lab-body-container">
    <div class="lab-container">
        {% if error %}
            <div class="error-card">
                <p><strong>Error:</strong> {{ error }}</p>
                <a href="{{ url_for('waste_classifier') }}" class="btn-primary-form">Try Again</a>
            </div>
        {% elif result %}
            <div class="result-card-wc">
                <div class="result-image">
                    <img src="data:image/jpeg;base64,{{ result.image_b64 }}" alt="Uploaded waste item">
                </div>
                <div class="result-text">
                    {{ result.text | safe }}
                </div>
            </div>
            <a href="{{ url_for('waste_classifier') }}" class="btn-primary-form">Classify Another Item</a>
        {% else %}
            <h2>AI Waste Classifier</h2>
            <p class="form-description">Drag & drop an image, or click to upload.</p>

            <form action="{{ url_for('classify_waste') }}" method="POST" enctype="multipart/form-data" id="upload-form">
                <div class="lab-drop-zone">
                    <input type="file" id="waste_image" name="waste_image" accept="image/*" class="lab-file-input" required>
                    <label for="waste_image" class="lab-drop-zone-label">
                        <img src="https://img.icons8.com/pastel-glyph/128/29c745/upload-to-cloud--v2.png" alt="upload icon" class="upload-icon">
                        <span id="file-label-text">Drag & drop image here, or click to browse.</span>
                    </label>
                    <img id="image-preview" src="#" alt="Image Preview" class="hidden"/>
                </div>

                <button type="submit" id="submit-button" class="lab-analyze-btn" disabled>Analyze</button>
                <div id="loader" class="loader hidden"></div>
            </form>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('upload-form');
    const input = document.getElementById('waste_image');
    const preview = document.getElementById('image-preview');
    const fileLabelText = document.getElementById('file-label-text');
    const submitButton = document.getElementById('submit-button');
    const loader = document.getElementById('loader');
    const dropZone = document.querySelector('.lab-drop-zone');
    const uploadIcon = document.querySelector('.upload-icon');

    // --- Drag and Drop Logic ---
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    ['dragleave', 'dragend'].forEach(type => {
        dropZone.addEventListener(type, () => {
            dropZone.classList.remove('drag-over');
        });
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
            input.files = e.dataTransfer.files;
            handleFileChange();
        }
    });

    // --- File Input Logic ---
    input.addEventListener('change', handleFileChange);

    function handleFileChange() {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                preview.src = event.target.result;
                preview.classList.remove('hidden');
                uploadIcon.classList.add('hidden');
                fileLabelText.textContent = file.name;
                submitButton.disabled = false;
                dropZone.classList.add('file-selected');
            }
            reader.readAsDataURL(file);
        }
    }

    // --- Form Submission Logic ---
    if(form) {
        form.addEventListener('submit', function() {
            submitButton.classList.add('hidden');
            loader.classList.remove('hidden');
        });
    }
});
</script>
{% endblock %}